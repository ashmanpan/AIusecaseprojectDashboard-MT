<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Production Deployment - AI Dashboard</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Frappe Gantt -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.min.css">
    <style>
        /* Infrastructure Requirements Grid */
        .infra-requirements {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .req-card {
            background: var(--card-bg);
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }
        .req-card label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }
        .req-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }
        .req-card input {
            width: 100%;
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.5rem;
            color: var(--primary-color);
        }
        .req-card input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        .req-card.calculated .value {
            color: var(--success-color);
        }

        /* Component Tabs */
        .component-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        .component-tab {
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .component-tab.active {
            background: var(--primary-color);
            color: white;
        }
        .component-tab i {
            font-size: 0.9rem;
        }

        /* Component Table */
        .component-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        .component-table th,
        .component-table td {
            padding: 0.6rem 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .component-table th {
            background: #f8fafc;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .component-table tbody tr:hover {
            background: #f8fafc;
        }

        /* Status Badges */
        .status-select {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
            background: white;
        }
        .status-NOT_STARTED { background: #f1f5f9; color: #64748b; }
        .status-IN_PROGRESS { background: #dbeafe; color: #1d4ed8; }
        .status-COMPLETED { background: #dcfce7; color: #166534; }
        .status-SCHEDULED { background: #fef3c7; color: #92400e; }
        .status-FAILED { background: #fee2e2; color: #991b1b; }

        /* Gantt Section */
        .gantt-section {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .gantt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .gantt-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }
        .gantt-controls {
            display: flex;
            gap: 0.5rem;
        }
        .gantt-controls button {
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
        }
        #ganttChart {
            min-height: 300px;
        }
        .gantt .bar-label {
            font-size: 11px;
        }

        /* Section Headers */
        .section-card {
            background: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            overflow: hidden;
        }
        .section-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        .section-header h2 {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .section-body {
            padding: 1rem;
        }

        /* Progress Bar */
        .progress-cell {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .progress-bar {
            flex: 1;
            height: 8px;
            background: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: var(--primary-color);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
            min-width: 35px;
        }

        /* Input Fields */
        .date-input, .text-input, .number-input {
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.8rem;
        }
        .text-input {
            width: 100%;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 0.25rem;
        }
        .btn-icon {
            padding: 0.25rem 0.5rem;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            border-radius: 4px;
        }
        .btn-icon:hover {
            background: #f1f5f9;
            color: var(--primary-color);
        }
        .btn-icon.danger:hover {
            color: var(--danger-color);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem;
            color: var(--text-secondary);
        }
        .empty-state i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        /* Migration Table */
        .migration-badge {
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .infra-requirements {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-left">
            <h1><i class="fas fa-rocket"></i> Production Deployment</h1>
        </div>
        <div class="header-right">
            <select id="tenantSelector" class="tenant-select">
                <option value="jio">Jio India</option>
                <option value="airtel">Airtel India - IP Transport</option>
                <option value="ioh">Indosat Ooredoo Hutchison (IOH) Indonesia</option>
                <option value="optus">Optus Australia</option>
                <option value="softbank">SoftBank Japan</option>
                <option value="kddi">KDDI Japan</option>
                <option value="ntt">NTT Japan</option>
                <option value="telstra">Telstra Australia</option>
                <option value="nbn">NBN Australia</option>
                <option value="pldt">PLDT Philippines</option>
                <option value="globe">Globe Telecom Philippines</option>
                <option value="xl">XL Axiata Indonesia</option>
                <option value="smart">Smart Communications Philippines</option>
            </select>
            <div class="user-menu">
                <span id="userName">Loading...</span>
                <span class="role-badge" id="userRole">-</span>
                <button class="btn btn-sm btn-secondary" onclick="Auth.signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>
    </header>

    <nav class="sidebar">
        <ul>
            <li><a href="index.html"><i class="fas fa-chart-line"></i> Dashboard</a></li>
            <li><a href="usecases.html"><i class="fas fa-brain"></i> Use Cases</a></li>
            <li><a href="infra.html"><i class="fas fa-server"></i> Infra Readiness</a></li>
            <li class="active"><a href="production.html"><i class="fas fa-rocket"></i> Production</a></li>
            <li><a href="approvals.html"><i class="fas fa-clipboard-check"></i> Approvals</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
        </ul>
    </nav>

    <main class="main-content">
        <!-- Infrastructure Requirements -->
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-server"></i> Infrastructure Requirements</h2>
                <button class="btn btn-sm btn-primary edit-only" onclick="saveInfraRequirements()">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
            <div class="section-body">
                <div class="infra-requirements">
                    <div class="req-card">
                        <label>CNC Instances</label>
                        <input type="number" id="cncInstances" min="0" onchange="calculateTotalVms()">
                    </div>
                    <div class="req-card">
                        <label>VMs per CNC</label>
                        <input type="number" id="vmsPerCnc" min="0" onchange="calculateTotalVms()">
                    </div>
                    <div class="req-card calculated">
                        <label>Total VMs</label>
                        <div class="value" id="totalVms">0</div>
                    </div>
                    <div class="req-card">
                        <label>Pilot Sites / Circles</label>
                        <input type="number" id="pilotSites" min="0">
                    </div>
                </div>
            </div>
        </div>

        <!-- Gantt Chart -->
        <div class="gantt-section">
            <div class="gantt-header">
                <h2><i class="fas fa-chart-gantt"></i> Deployment Timeline</h2>
                <div class="gantt-controls">
                    <button class="btn btn-sm btn-secondary" onclick="changeGanttView('Day')">Day</button>
                    <button class="btn btn-sm btn-secondary" onclick="changeGanttView('Week')">Week</button>
                    <button class="btn btn-sm btn-secondary" onclick="changeGanttView('Month')">Month</button>
                </div>
            </div>
            <div id="ganttChart"></div>
            <div id="ganttEmpty" class="empty-state" style="display: none;">
                <i class="fas fa-calendar-alt"></i>
                <p>No deployment components with dates. Add components below to see the timeline.</p>
            </div>
        </div>

        <!-- Deployment Components -->
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-cubes"></i> Deployment Components</h2>
                <button class="btn btn-sm btn-primary edit-only" onclick="openAddComponentModal()">
                    <i class="fas fa-plus"></i> Add Component
                </button>
            </div>
            <div class="section-body">
                <div class="component-tabs" id="componentTabs">
                    <!-- Tabs generated by JavaScript -->
                </div>
                <table class="component-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">Name</th>
                            <th style="width: 12%">Status</th>
                            <th style="width: 10%">Start Date</th>
                            <th style="width: 10%">End Date</th>
                            <th style="width: 12%">Owner</th>
                            <th style="width: 15%">Progress</th>
                            <th style="width: 10%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="componentsTableBody">
                        <!-- Components rendered by JavaScript -->
                    </tbody>
                </table>
                <div id="componentsEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-cube"></i>
                    <p>No components added yet. Click "Add Component" to get started.</p>
                </div>
            </div>
        </div>

        <!-- Use Case Migrations -->
        <div class="section-card">
            <div class="section-header">
                <h2><i class="fas fa-exchange-alt"></i> Use Case Migrations</h2>
                <button class="btn btn-sm btn-primary edit-only" onclick="openAddMigrationModal()">
                    <i class="fas fa-plus"></i> Add Migration
                </button>
            </div>
            <div class="section-body">
                <table class="component-table">
                    <thead>
                        <tr>
                            <th style="width: 25%">Use Case</th>
                            <th style="width: 15%">Status</th>
                            <th style="width: 12%">Target Date</th>
                            <th style="width: 12%">Actual Date</th>
                            <th style="width: 15%">Owner</th>
                            <th style="width: 15%">Notes</th>
                            <th style="width: 6%">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="migrationsTableBody">
                        <!-- Migrations rendered by JavaScript -->
                    </tbody>
                </table>
                <div id="migrationsEmpty" class="empty-state" style="display: none;">
                    <i class="fas fa-exchange-alt"></i>
                    <p>No migration plans yet. Click "Add Migration" to schedule use case deployments.</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Add Component Modal -->
    <div id="addComponentModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addComponentModal')">&times;</span>
            <h2>Add Deployment Component</h2>
            <form id="addComponentForm" onsubmit="addComponent(event)">
                <div class="form-group">
                    <label for="componentType">Component Type *</label>
                    <select id="componentType" required>
                        <!-- Options generated by JavaScript -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="componentName">Name *</label>
                    <input type="text" id="componentName" required placeholder="e.g., CNC Primary Cluster">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="componentStartDate">Start Date</label>
                        <input type="date" id="componentStartDate">
                    </div>
                    <div class="form-group">
                        <label for="componentEndDate">End Date</label>
                        <input type="date" id="componentEndDate">
                    </div>
                </div>
                <div class="form-group">
                    <label for="componentOwner">Owner</label>
                    <input type="text" id="componentOwner" placeholder="e.g., John Doe">
                </div>
                <div class="form-group">
                    <label for="componentNotes">Notes</label>
                    <textarea id="componentNotes" rows="2" placeholder="Additional notes..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addComponentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Component</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Migration Modal -->
    <div id="addMigrationModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addMigrationModal')">&times;</span>
            <h2>Add Use Case Migration</h2>
            <form id="addMigrationForm" onsubmit="addMigration(event)">
                <div class="form-group">
                    <label for="migrationUseCase">Use Case *</label>
                    <select id="migrationUseCase" required>
                        <!-- Options generated by JavaScript from existing use cases -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="migrationTargetDate">Target Date</label>
                    <input type="date" id="migrationTargetDate">
                </div>
                <div class="form-group">
                    <label for="migrationOwner">Owner</label>
                    <input type="text" id="migrationOwner" placeholder="e.g., Migration Team">
                </div>
                <div class="form-group">
                    <label for="migrationNotes">Notes</label>
                    <textarea id="migrationNotes" rows="2" placeholder="Prerequisites, dependencies..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addMigrationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Migration</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.1.24.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/frappe-gantt/dist/frappe-gantt.umd.min.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/data.js"></script>
    <script src="js/dynamodb.js"></script>
    <script src="js/production-db.js"></script>
    <script>
        // State
        let currentTenant = 'jio';
        let currentComponentType = 'CNC';
        let components = [];
        let migrations = [];
        let ganttChart = null;
        let canEdit = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            // Check authentication
            if (!Auth.requireAuth()) return;

            // Get user info
            const user = Auth.getCurrentUser();
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userRole').textContent = formatRole(user.role);
                currentTenant = user.tenantId || 'jio';

                // Show/hide tenant selector based on role
                if (user.role === 'ADMIN' || user.tenantId === null || (user.editableTenants && user.editableTenants.length > 1)) {
                    document.getElementById('tenantSelector').value = currentTenant;
                } else {
                    document.getElementById('tenantSelector').style.display = 'none';
                }

                // Check edit permissions
                canEdit = canEditTenant(user, currentTenant);
                updateEditPermissions();
            }

            // Initialize component tabs
            renderComponentTabs();

            // Initialize component type dropdown
            populateComponentTypes();

            // Load data
            await loadAllData();
        });

        function formatRole(role) {
            const roleMap = {
                'ADMIN': 'Admin',
                'TEAM_LEAD': 'Team Lead',
                'TEAM_MEMBER': 'Team Member',
                'CUSTOMER_INCHARGE': 'Customer',
                'VIEWER': 'Viewer'
            };
            return roleMap[role] || role;
        }

        function updateEditPermissions() {
            const user = Auth.getCurrentUser();
            canEdit = canEditTenant(user, currentTenant);

            // Show/hide edit buttons
            document.querySelectorAll('.edit-only').forEach(el => {
                el.style.display = canEdit ? '' : 'none';
            });

            // Enable/disable inputs
            document.querySelectorAll('#cncInstances, #vmsPerCnc, #pilotSites').forEach(el => {
                el.disabled = !canEdit;
            });
        }

        // Tenant selector change
        document.getElementById('tenantSelector').addEventListener('change', async function(e) {
            currentTenant = e.target.value;
            updateEditPermissions();
            await loadAllData();
        });

        // Load all data
        async function loadAllData() {
            await Promise.all([
                loadInfraRequirements(),
                loadComponents(),
                loadMigrations()
            ]);
            renderGanttChart();
        }

        // ==================== INFRASTRUCTURE REQUIREMENTS ====================

        async function loadInfraRequirements() {
            const data = await ProductionDB.getInfraRequirements(currentTenant);
            document.getElementById('cncInstances').value = data.cncInstances || 0;
            document.getElementById('vmsPerCnc').value = data.vmsPerCnc || 0;
            document.getElementById('totalVms').textContent = data.totalVms || 0;
            document.getElementById('pilotSites').value = data.pilotSites || 0;
        }

        function calculateTotalVms() {
            const cnc = parseInt(document.getElementById('cncInstances').value) || 0;
            const vms = parseInt(document.getElementById('vmsPerCnc').value) || 0;
            document.getElementById('totalVms').textContent = cnc * vms;
        }

        async function saveInfraRequirements() {
            const requirements = {
                cncInstances: parseInt(document.getElementById('cncInstances').value) || 0,
                vmsPerCnc: parseInt(document.getElementById('vmsPerCnc').value) || 0,
                pilotSites: parseInt(document.getElementById('pilotSites').value) || 0
            };

            const result = await ProductionDB.updateInfraRequirements(currentTenant, requirements);
            if (result.success) {
                showNotification('Infrastructure requirements saved', 'success');
                document.getElementById('totalVms').textContent = result.item.totalVms;
            } else {
                showNotification('Failed to save: ' + result.error, 'danger');
            }
        }

        // ==================== COMPONENT TABS ====================

        function renderComponentTabs() {
            const container = document.getElementById('componentTabs');
            container.innerHTML = DEPLOYMENT_COMPONENTS.map(comp => `
                <button class="component-tab ${comp.id === currentComponentType ? 'active' : ''}"
                        onclick="switchComponentTab('${comp.id}')">
                    <i class="fas ${comp.icon}"></i>
                    ${comp.name}
                </button>
            `).join('');
        }

        function switchComponentTab(type) {
            currentComponentType = type;
            renderComponentTabs();
            renderComponents();
        }

        function populateComponentTypes() {
            const select = document.getElementById('componentType');
            select.innerHTML = DEPLOYMENT_COMPONENTS.map(comp =>
                `<option value="${comp.id}">${comp.name}</option>`
            ).join('');
        }

        // ==================== COMPONENTS ====================

        async function loadComponents() {
            components = await ProductionDB.getComponents(currentTenant);
            renderComponents();
        }

        function renderComponents() {
            const filteredComponents = components.filter(c => c.componentType === currentComponentType);
            const tbody = document.getElementById('componentsTableBody');
            const emptyState = document.getElementById('componentsEmpty');

            if (filteredComponents.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = filteredComponents.map(comp => `
                <tr>
                    <td><strong>${comp.name}</strong></td>
                    <td>
                        <select class="status-select status-${comp.status}" ${!canEdit ? 'disabled' : ''}
                                onchange="updateComponentField('${comp.recordId}', 'status', this.value);
                                         this.className='status-select status-'+this.value;">
                            ${DEPLOYMENT_STATUS.map(s =>
                                `<option value="${s.id}" ${comp.status === s.id ? 'selected' : ''}>${s.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="date" class="date-input" value="${comp.startDate || ''}" ${!canEdit ? 'disabled' : ''}
                               onchange="updateComponentField('${comp.recordId}', 'startDate', this.value)">
                    </td>
                    <td>
                        <input type="date" class="date-input" value="${comp.endDate || ''}" ${!canEdit ? 'disabled' : ''}
                               onchange="updateComponentField('${comp.recordId}', 'endDate', this.value)">
                    </td>
                    <td>
                        <input type="text" class="text-input" value="${comp.owner || ''}" ${!canEdit ? 'disabled' : ''}
                               placeholder="Owner" style="width: 100px;"
                               onchange="updateComponentField('${comp.recordId}', 'owner', this.value)">
                    </td>
                    <td>
                        <div class="progress-cell">
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: ${comp.progress || 0}%"></div>
                            </div>
                            <input type="number" class="number-input" value="${comp.progress || 0}"
                                   min="0" max="100" style="width: 50px;" ${!canEdit ? 'disabled' : ''}
                                   onchange="updateComponentField('${comp.recordId}', 'progress', parseInt(this.value))">
                            <span class="progress-text">%</span>
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit ? `
                            <button class="btn-icon danger" onclick="deleteComponent('${comp.recordId}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function updateComponentField(recordId, field, value) {
            const updates = {};
            updates[field] = value;
            const result = await ProductionDB.updateComponent(currentTenant, recordId, updates);
            if (result.success) {
                // Update local state
                const comp = components.find(c => c.recordId === recordId);
                if (comp) comp[field] = value;

                // Update Gantt if dates changed
                if (field === 'startDate' || field === 'endDate' || field === 'progress') {
                    renderGanttChart();
                }
            } else {
                showNotification('Failed to update: ' + result.error, 'danger');
            }
        }

        function openAddComponentModal() {
            document.getElementById('addComponentForm').reset();
            document.getElementById('componentType').value = currentComponentType;
            document.getElementById('addComponentModal').classList.add('active');
        }

        async function addComponent(event) {
            event.preventDefault();

            const componentData = {
                componentType: document.getElementById('componentType').value,
                name: document.getElementById('componentName').value,
                startDate: document.getElementById('componentStartDate').value,
                endDate: document.getElementById('componentEndDate').value,
                owner: document.getElementById('componentOwner').value,
                notes: document.getElementById('componentNotes').value
            };

            const result = await ProductionDB.addComponent(currentTenant, componentData);
            if (result.success) {
                closeModal('addComponentModal');
                showNotification('Component added successfully', 'success');
                await loadComponents();
                renderGanttChart();
            } else {
                showNotification('Failed to add component: ' + result.error, 'danger');
            }
        }

        async function deleteComponent(recordId) {
            if (!confirm('Are you sure you want to delete this component?')) return;

            const result = await ProductionDB.deleteComponent(currentTenant, recordId);
            if (result.success) {
                showNotification('Component deleted', 'success');
                await loadComponents();
                renderGanttChart();
            } else {
                showNotification('Failed to delete: ' + result.error, 'danger');
            }
        }

        // ==================== GANTT CHART ====================

        function renderGanttChart() {
            const container = document.getElementById('ganttChart');
            const emptyState = document.getElementById('ganttEmpty');

            // Filter components with dates
            const tasksWithDates = components.filter(c => c.startDate && c.endDate);

            if (tasksWithDates.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
                if (ganttChart) ganttChart = null;
                return;
            }

            emptyState.style.display = 'none';

            const tasks = tasksWithDates.map(comp => {
                const compDef = DEPLOYMENT_COMPONENTS.find(d => d.id === comp.componentType);
                return {
                    id: comp.recordId,
                    name: `${compDef ? compDef.name : comp.componentType}: ${comp.name}`,
                    start: comp.startDate,
                    end: comp.endDate,
                    progress: comp.progress || 0,
                    custom_class: `bar-${comp.status.toLowerCase()}`
                };
            });

            try {
                container.innerHTML = '';
                ganttChart = new Gantt("#ganttChart", tasks, {
                    view_mode: 'Week',
                    date_format: 'YYYY-MM-DD',
                    custom_popup_html: function(task) {
                        return `
                            <div class="details-container">
                                <h5>${task.name}</h5>
                                <p>Progress: ${task.progress}%</p>
                                <p>${task.start} to ${task.end}</p>
                            </div>
                        `;
                    },
                    on_date_change: async function(task, start, end) {
                        if (!canEdit) return;
                        await updateComponentField(task.id, 'startDate', formatDate(start));
                        await updateComponentField(task.id, 'endDate', formatDate(end));
                    },
                    on_progress_change: async function(task, progress) {
                        if (!canEdit) return;
                        await updateComponentField(task.id, 'progress', Math.round(progress));
                    }
                });
            } catch (e) {
                console.error('Gantt chart error:', e);
                container.innerHTML = '<p class="text-muted">Unable to render Gantt chart</p>';
            }
        }

        function changeGanttView(mode) {
            if (ganttChart) {
                ganttChart.change_view_mode(mode);
            }
        }

        function formatDate(date) {
            const d = new Date(date);
            return d.toISOString().split('T')[0];
        }

        // ==================== MIGRATIONS ====================

        async function loadMigrations() {
            migrations = await ProductionDB.getMigrations(currentTenant);
            renderMigrations();
            populateUseCaseDropdown();
        }

        function renderMigrations() {
            const tbody = document.getElementById('migrationsTableBody');
            const emptyState = document.getElementById('migrationsEmpty');

            if (migrations.length === 0) {
                tbody.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';
            tbody.innerHTML = migrations.map(mig => `
                <tr>
                    <td><strong>${mig.useCaseName}</strong></td>
                    <td>
                        <select class="status-select status-${mig.migrationStatus}" ${!canEdit ? 'disabled' : ''}
                                onchange="updateMigrationField('${mig.recordId}', 'migrationStatus', this.value);
                                         this.className='status-select status-'+this.value;">
                            ${MIGRATION_STATUS.map(s =>
                                `<option value="${s.id}" ${mig.migrationStatus === s.id ? 'selected' : ''}>${s.name}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td>
                        <input type="date" class="date-input" value="${mig.targetDate || ''}" ${!canEdit ? 'disabled' : ''}
                               onchange="updateMigrationField('${mig.recordId}', 'targetDate', this.value)">
                    </td>
                    <td>
                        <input type="date" class="date-input" value="${mig.actualDate || ''}" ${!canEdit ? 'disabled' : ''}
                               onchange="updateMigrationField('${mig.recordId}', 'actualDate', this.value)">
                    </td>
                    <td>
                        <input type="text" class="text-input" value="${mig.owner || ''}" ${!canEdit ? 'disabled' : ''}
                               placeholder="Owner" style="width: 100px;"
                               onchange="updateMigrationField('${mig.recordId}', 'owner', this.value)">
                    </td>
                    <td>
                        <input type="text" class="text-input" value="${mig.notes || ''}" ${!canEdit ? 'disabled' : ''}
                               placeholder="Notes..."
                               onchange="updateMigrationField('${mig.recordId}', 'notes', this.value)">
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${canEdit ? `
                            <button class="btn-icon danger" onclick="deleteMigration('${mig.recordId}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        async function updateMigrationField(recordId, field, value) {
            const updates = {};
            updates[field] = value;
            const result = await ProductionDB.updateMigration(currentTenant, recordId, updates);
            if (result.success) {
                const mig = migrations.find(m => m.recordId === recordId);
                if (mig) mig[field] = value;
            } else {
                showNotification('Failed to update: ' + result.error, 'danger');
            }
        }

        function populateUseCaseDropdown() {
            const select = document.getElementById('migrationUseCase');
            // Get use cases from AppData that belong to current tenant
            const useCases = AppData.useCases.filter(uc => uc.tenantId === currentTenant);

            // Filter out already migrated ones
            const migratedIds = migrations.map(m => m.useCaseId);
            const availableUseCases = useCases.filter(uc => !migratedIds.includes(uc.id));

            select.innerHTML = availableUseCases.map(uc =>
                `<option value="${uc.id}" data-name="${uc.name}">${uc.name}</option>`
            ).join('');

            if (availableUseCases.length === 0) {
                select.innerHTML = '<option value="">No use cases available</option>';
            }
        }

        function openAddMigrationModal() {
            document.getElementById('addMigrationForm').reset();
            populateUseCaseDropdown();
            document.getElementById('addMigrationModal').classList.add('active');
        }

        async function addMigration(event) {
            event.preventDefault();

            const select = document.getElementById('migrationUseCase');
            const selectedOption = select.options[select.selectedIndex];

            const migrationData = {
                useCaseId: select.value,
                useCaseName: selectedOption.dataset.name || selectedOption.textContent,
                targetDate: document.getElementById('migrationTargetDate').value,
                owner: document.getElementById('migrationOwner').value,
                notes: document.getElementById('migrationNotes').value
            };

            const result = await ProductionDB.addMigration(currentTenant, migrationData);
            if (result.success) {
                closeModal('addMigrationModal');
                showNotification('Migration plan added', 'success');
                await loadMigrations();
            } else {
                showNotification('Failed to add migration: ' + result.error, 'danger');
            }
        }

        async function deleteMigration(recordId) {
            if (!confirm('Are you sure you want to delete this migration plan?')) return;

            const result = await ProductionDB.deleteMigration(currentTenant, recordId);
            if (result.success) {
                showNotification('Migration plan deleted', 'success');
                await loadMigrations();
            } else {
                showNotification('Failed to delete: ' + result.error, 'danger');
            }
        }

        // ==================== UTILITIES ====================

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        };

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
                <span>${message}</span>
            `;
            document.body.appendChild(notification);

            setTimeout(() => notification.classList.add('show'), 100);
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }
    </script>
</body>
</html>
